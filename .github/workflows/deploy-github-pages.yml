name: Deploy (zip → GitHub Pages)

on:
  push:
    branches: ["main"]

permissions:
  contents: write

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Extract app zip
        run: |
          set -e
          rm -rf app
          ZIP_FILE="westeros-chronicles-angular.zip"
          if [ ! -f "$ZIP_FILE" ]; then
            echo "Arquivo $ZIP_FILE não encontrado na raiz do repositório." >&2
            echo "Coloque o ZIP na raiz com esse nome (ou ajuste o workflow)." >&2
            exit 1
          fi
          unzip -q "$ZIP_FILE" -d app
          # Se o zip veio com uma pasta interna, normalize para app/
          if [ -d "app/westeros-chronicles-angular" ]; then
            mv app/westeros-chronicles-angular/* app/
            rm -rf app/westeros-chronicles-angular
          fi

      - name: Install deps
        working-directory: ./app
        run: npm install

      - name: Build
        working-directory: ./app
        run: npm run build -- --configuration production --base-href "/${{ github.event.repository.name }}/"

      - name: Prepare Pages folder
        run: |
          set -e
          rm -rf site
          mkdir -p site
          # Descobre onde está o index.html gerado
          OUT_DIR=$(dirname "$(find app/dist -name index.html -maxdepth 5 | head -n 1)")
          if [ -z "$OUT_DIR" ] || [ ! -f "$OUT_DIR/index.html" ]; then
            echo "Não encontrei index.html em app/dist" >&2
            find app/dist -maxdepth 4 -type f | head -n 50 || true
            exit 1
          fi
          echo "Publicando de: $OUT_DIR"
          cp -R "$OUT_DIR"/* site/

      - name: Deploy
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
