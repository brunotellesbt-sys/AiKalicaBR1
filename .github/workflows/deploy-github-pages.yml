- name: Patch (Gen 9 images + bigger & sharper wheel on mobile + PIX only + evolution regional rules)
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          set -e
          python3 - <<'PY'
          import re
          import subprocess
          import sys
          from pathlib import Path

          # ---------------------------
          # Existing patch: Gen 9 trainer images
          # ---------------------------
          trainer = Path("src/app/services/trainer-service/trainer-sprite-data.ts")
          if trainer.exists():
              txt = trainer.read_text(encoding="utf-8")
              txt = txt.replace(
                  "https://archives.bulbagarden.net/media/upload/6/62/Spr_Masters_Florian_2.png",
                  "https://raw.githubusercontent.com/zeroxm/pokemon-roulette-trainer-sprites/main/sprites/Spr_Masters_Florian_2.png"
              )
              txt = txt.replace(
                  "https://archives.bulbagarden.net/media/upload/4/4a/Spr_Masters_Juliana.png",
                  "https://raw.githubusercontent.com/zeroxm/pokemon-roulette-trainer-sprites/main/sprites/Spr_Masters_Juliana.png"
              )
              trainer.write_text(txt, encoding="utf-8")

          # ---------------------------
          # Existing patch: bigger & sharper wheel on mobile
          # ---------------------------
          wheel_ts = Path("src/app/wheel/wheel.component.ts")
          if wheel_ts.exists():
              txt = wheel_ts.read_text(encoding="utf-8")

              txt = re.sub(
                  r"this\.canvasHeight\s*=\s*Math\.min\(window\.innerHeight,\s*window\.innerWidth\)\s*\*\s*0\.50\s*;",
                  "const minDim = Math.min(window.innerHeight, window.innerWidth);\n"
                  "    const isMobile = window.innerWidth <= 768;\n"
                  "    this.canvasHeight = minDim * (isMobile ? 0.72 : 0.50);",
                  txt,
                  count=1
              )

              txt = txt.replace("const centerX = this.wheelCanvas.width / 2;", "const centerX = this.wheelWidth / 2;")
              txt = txt.replace("const centerY = this.wheelCanvas.height / 2;", "const centerY = this.canvasHeight / 2;")
              txt = txt.replace("const radius = (this.wheelCanvas.width / 2);", "const radius = (this.wheelWidth / 2);")
              txt = txt.replace(
                  "this.wheelCtx.clearRect(0, 0, this.wheelCanvas.width, this.wheelCanvas.height);",
                  "this.wheelCtx.clearRect(0, 0, this.wheelWidth, this.canvasHeight);"
              )

              txt = re.sub(
                  r"\n\s*drawPointer\(\): void \{[\s\S]*?\n\s*\}\n\n\s*spinWheel\(",
                  "\n  drawPointer(): void {\n"
                  "    const midY = this.canvasHeight / 2;\n"
                  "    const xRight = this.cursorWidth - 2;\n"
                  "    const tipX = 2;\n\n"
                  "    this.pointerCtx.save();\n"
                  "    this.pointerCtx.lineWidth = 2;\n"
                  "    this.pointerCtx.strokeStyle = this.pointerStrokeColor;\n"
                  "    this.pointerCtx.fillStyle = this.pointerFillColor;\n"
                  "    this.pointerCtx.beginPath();\n"
                  "    this.pointerCtx.moveTo(xRight, midY - 20);\n"
                  "    this.pointerCtx.lineTo(xRight, midY + 20);\n"
                  "    this.pointerCtx.lineTo(tipX, midY);\n"
                  "    this.pointerCtx.closePath();\n"
                  "    this.pointerCtx.stroke();\n"
                  "    this.pointerCtx.fill();\n"
                  "    this.pointerCtx.restore();\n"
                  "  }\n\n"
                  "  spinWheel(",
                  txt,
                  count=1
              )

              if "setupHiDpiCanvases" not in txt:
                  marker = "this.pointerCtx = this.pointerCanvas.getContext('2d')!;"
                  if marker in txt and "this.setupHiDpiCanvases();" not in txt:
                      txt = txt.replace(marker, marker + "\n    this.setupHiDpiCanvases();", 1)

                  method = """
            private setupHiDpiCanvases(): void {
              const dpr = window.devicePixelRatio || 1;

              this.wheelCanvas.width = Math.floor(this.wheelWidth * dpr);
              this.wheelCanvas.height = Math.floor(this.canvasHeight * dpr);
              this.wheelCanvas.style.width = `${this.wheelWidth}px`;
              this.wheelCanvas.style.height = `${this.canvasHeight}px`;
              this.wheelCtx.setTransform(dpr, 0, 0, dpr, 0, 0);

              this.pointerCanvas.width = Math.floor(this.cursorWidth * dpr);
              this.pointerCanvas.height = Math.floor(this.canvasHeight * dpr);
              this.pointerCanvas.style.width = `${this.cursorWidth}px`;
              this.pointerCanvas.style.height = `${this.canvasHeight}px`;
              this.pointerCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
            }
          """
                  last = txt.rfind("}")
                  if last != -1:
                      txt = txt[:last] + method + "\n" + txt[last:]

              wheel_ts.write_text(txt, encoding="utf-8")

          wheel_css = Path("src/app/wheel/wheel.component.css")
          if wheel_css.exists():
              css = (
                  ".wheel-container{display:flex;flex-direction:column;align-items:center}\n"
                  ".wheel-container p{font-size:clamp(1.05rem,4.6vw,1.5rem);font-weight:700;text-align:center;"
                  "max-width:min(92vw,520px);padding:0 .75rem;line-height:1.2;overflow-wrap:anywhere;word-break:break-word;"
                  "margin:.5rem 0 0}\n"
                  ".canvas-container{display:flex;flex-direction:row;align-items:center;justify-content:center;margin-left:0}\n"
              )
              wheel_css.write_text(css, encoding="utf-8")

          # ---------------------------
          # NEW: PIX-only donation page (remove international)
          # ---------------------------
          pix_key = "f1f43bfc-b355-4102-b530-256a03241385"

          coffee_html = Path("src/app/coffee/coffee.component.html")
          if coffee_html.exists():
              coffee_html.write_text(f"""<div class="row">
    <div class="col-12 col-sm-2">
        <div class="row py-4">
            <div class="col-6 col-sm-12 mb-2">
                <app-main-game-button></app-main-game-button>
            </div>
            <div class="col-6 col-sm-12 mb-2">
                <app-credits-button></app-credits-button>
            </div>
        </div>
    </div>
    <div class="col-12 col-sm-9">
        <div class="container text-center">
            <div class="mt-2">
                <h3>{{{{ 'coffee.title' | translate}}}}</h3>
                <p>{{{{ 'coffee.how_to_help' | translate }}}}</p>
                <p>{{{{ 'coffee.donations' | translate }}}}</p>
            </div>
            <h1 class="mt-sm-5"><ng-icon name="bootstrapCupHotFill"></ng-icon></h1>
            <div>
                <h3>{{{{ 'coffee.support' | translate }}}}</h3>
                <div class="row justify-content-center">
                    <div class="col-12 col-md-8">
                        <p>ðŸ‡§ðŸ‡· Ã‰ do Brasil? ðŸ‡§ðŸ‡· Manda um PIX! ðŸ‡§ðŸ‡·</p>
                        <img appImgFallback src="qr_code.jpeg" alt="PIX QR Code" style="height: 225px;" class="img-fluid" (click)="copyPixCode()">
                        <p class="mt-3 mb-1"><strong>Chave PIX:</strong></p>
                        <p class="mb-2" style="word-break: break-all;">{{{{ pixKey }}}}</p>
                        <a href="javascript:void(0)" class="link-primary" (click)="copyPixCode()">
                            {{{{pixCodeCopied ? 'PIX copiado!' : 'Clique para copiar!'}}}}
                        </a>
                    </div>
                </div>
            </div>

            <div class="mt-5">
                <h3>{{{{ 'coffee.thanks' | translate }}}}</h3>
                <p>{{{{ 'coffee.hope' | translate }}}}</p>
            </div>
        </div>
    </div>
  </div>
""", encoding="utf-8")

          coffee_ts = Path("src/app/coffee/coffee.component.ts")
          if coffee_ts.exists():
              coffee_ts.write_text(f"""import {{ Component }} from '@angular/core';
import {{ NgIconsModule }} from '@ng-icons/core';
import {{ MainGameButtonComponent }} from "../main-game-button/main-game-button.component";
import {{ CommonModule }} from '@angular/common';
import {{ TranslatePipe }} from '@ngx-translate/core';
import {{ ImgFallbackDirective }} from '../shared/img-fallback.directive';
import {{ CreditsButtonComponent }} from "../main-game/credits-button/credits-button.component";

@Component({{
  selector: 'app-coffee',
  imports: [
    ImgFallbackDirective,
    CommonModule,
    NgIconsModule,
    MainGameButtonComponent,
    TranslatePipe,
    CreditsButtonComponent
  ],
  templateUrl: './coffee.component.html',
  styleUrl: './coffee.component.css'
}})
export class CoffeeComponent {{

  readonly pixKey = '{pix_key}';
  pixCodeCopied = false;

  copyPixCode(): void {{
    navigator.clipboard.writeText(this.pixKey).then(() => {{
      this.pixCodeCopied = true;
      setTimeout(() => (this.pixCodeCopied = false), 2000);
    }}).catch((err) => {{
      console.error('Could not copy PIX key: ', err);
    }});
  }}
}}
""", encoding="utf-8")

          # Generate a PIX QR code (BR Code EMV) into public/qr_code.jpeg
          # (installs qrcode/pillow if missing)
          def ensure_import(mod, pip_name=None):
              try:
                  __import__(mod)
              except Exception:
                  pkg = pip_name or mod
                  subprocess.check_call([sys.executable, "-m", "pip", "install", "--quiet", pkg])

          ensure_import("qrcode")
          ensure_import("PIL", "pillow")

          import qrcode
          from PIL import Image

          def crc16_ccitt(payload: str) -> str:
              crc = 0xFFFF
              for b in payload.encode("utf-8"):
                  crc ^= (b << 8)
                  for _ in range(8):
                      if crc & 0x8000:
                          crc = ((crc << 1) ^ 0x1021) & 0xFFFF
                      else:
                          crc = (crc << 1) & 0xFFFF
              return f"{crc:04X}"

          def tlv(tag: str, value: str) -> str:
              ln = f"{len(value):02d}"
              return f"{tag}{ln}{value}"

          # Minimal static PIX payload (works for most banks)
          gui = tlv("00", "BR.GOV.BCB.PIX")
          key = tlv("01", pix_key)
          desc = tlv("02", "PokeRoleta")
          mai_26 = tlv("26", gui + key + desc)

          payload = ""
          payload += tlv("00", "01")         # Payload format indicator
          payload += tlv("01", "11")         # Static
          payload += mai_26
          payload += tlv("52", "0000")       # MCC
          payload += tlv("53", "986")        # BRL
          payload += tlv("58", "BR")         # Country
          payload += tlv("59", "POKEROLETA") # Merchant name
          payload += tlv("60", "BRASIL")     # Merchant city
          payload += tlv("62", tlv("05", "POKEROLETA"))  # Reference

          payload_for_crc = payload + "6304"
          payload = payload_for_crc + crc16_ccitt(payload_for_crc)

          qr_img = qrcode.QRCode(
              version=None,
              error_correction=qrcode.constants.ERROR_CORRECT_M,
              box_size=10,
              border=2,
          )
          qr_img.add_data(payload)
          qr_img.make(fit=True)
          img = qr_img.make_image(fill_color="black", back_color="white").convert("RGB")
          img = img.resize((530, 530), Image.NEAREST)

          out_qr = Path("public/qr_code.jpeg")
          out_qr.parent.mkdir(parents=True, exist_ok=True)
          img.save(out_qr, format="JPEG", quality=95)

          # ---------------------------
          # NEW: Evolution fix (prevents empty-evo freezes + regional rules + Hisui exception)
          # ---------------------------
          evo_service = Path("src/app/services/evolution-service/evolution.service.ts")
          if evo_service.exists():
              evo_service.write_text("""import { Injectable } from '@angular/core';
import { PokemonItem } from '../../interfaces/pokemon-item';
import { evolutionChain } from './evolution-chain';
import { PokemonService } from '../pokemon-service/pokemon.service';

@Injectable({
  providedIn: 'root'
})
export class EvolutionService {

  constructor(private pokemonService: PokemonService) {
    this.nationalDexPokemon = this.pokemonService.getAllPokemon();
  }

  evolutionChain = evolutionChain;
  nationalDexPokemon: PokemonItem[];

  /**
   * Hisui isn't a playable "generation region" in this game, so we allow Hisuian
   * forms as evolution targets even when the base PokÃ©mon isn't regional.
   *
   * In this codebase, Hisuian forms are typically in the PokeAPI form-id range:
   * 10229..10247
   */
  private isHisuianFormId(id: number): boolean {
    return id >= 10229 && id <= 10247;
  }

  /**
   * A PokÃ©mon can evolve only if there is at least one valid evolution after
   * applying the game's regional rules.
   */
  canEvolve(pokemon: PokemonItem): boolean {
    return this.getEvolutions(pokemon).length > 0;
  }

  /**
   * Evolution rules implemented:
   * - If the base PokÃ©mon is a *regional form* (has basePokemonId), it only evolves
   *   through its own chain (as defined in evolutionChain).
   * - If the base PokÃ©mon is the *original* form (no basePokemonId), it evolves only
   *   into *non-regional* evolutions (no basePokemonId),
   *   EXCEPT: allow Hisuian form evolutions.
   */
  getEvolutions(pokemon: PokemonItem): PokemonItem[] {
    const chain = this.evolutionChain[pokemon.pokemonId];
    if (!chain || chain.length === 0) return [];

    const candidates: PokemonItem[] = chain
      .map((evolutionId) => this.pokemonService.getPokemonById(evolutionId))
      .filter((p): p is PokemonItem => !!p);

    // Non-regional base: remove non-Hisui regional-form evolution targets.
    if (!pokemon.basePokemonId) {
      return candidates.filter((evo) => !evo.basePokemonId || this.isHisuianFormId(evo.pokemonId));
    }

    // Regional base: keep whatever the chain defines.
    return candidates;
  }
}
""", encoding="utf-8")

          print("Patch applied: PIX-only + QR + evolution rules/fix.")
          PY
