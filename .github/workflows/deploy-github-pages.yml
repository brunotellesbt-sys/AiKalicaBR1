name: Deploy to GitHub Pages (from zip)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

env:
  ZIP_FILE: pokemon-roulette-source.zip

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Unzip source
        run: |
          set -e
          if [ ! -f "${{ env.ZIP_FILE }}" ]; then
            echo "ERROR: zip '${{ env.ZIP_FILE }}' not found."
            ls -la *.zip || true
            exit 1
          fi
          rm -rf app
          mkdir -p app
          unzip -q "${{ env.ZIP_FILE }}" -d app
          ls -la app

      - name: Find project root (package.json)
        run: |
          set -e
          ROOT="$(find app -maxdepth 12 -name package.json -print -quit | xargs -r dirname)"
          if [ -z "$ROOT" ]; then
            echo "ERROR: package.json not found inside zip."
            exit 1
          fi
          echo "PROJECT_ROOT=$ROOT" >> $GITHUB_ENV
          ls -la "$ROOT"

      - name: Install dependencies
        working-directory: ${{ env.PROJECT_ROOT }}
        run: npm install --legacy-peer-deps

      - name: Install @angular/localize (match Angular version)
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          set -e
          CORE_VER=$(node -p "require('./package.json').dependencies?.['@angular/core'] || require('./package.json').devDependencies?.['@angular/core'] || ''")
          if [ -z "$CORE_VER" ]; then
            echo "ERROR: Could not detect @angular/core version from package.json"
            exit 1
          fi
          CORE_VER="${CORE_VER#^}"
          CORE_VER="${CORE_VER#~}"
          npm install @angular/localize@$CORE_VER --legacy-peer-deps

      - name: Patch (trainer Gen9 + wheel mobile + PIX only + evolution rules/fix)
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          set -e
          python3 - <<'PY'
          import re
          import subprocess
          import sys
          from pathlib import Path

          PIX_KEY = "f1f43bfc-b355-4102-b530-256a03241385"

          # ------------------------------------------------------------
          # (A) Guarantee Gen 9 trainer sprites (Florian / Juliana)
          # ------------------------------------------------------------
          trainer = Path("src/app/services/trainer-service/trainer-sprite-data.ts")
          if trainer.exists():
              txt = trainer.read_text(encoding="utf-8")

              # Force generation 9 male/female urls (robust)
              txt = re.sub(
                  r"(9\s*:\s*\{[\s\S]*?male\s*:\s*)'[^']*'",
                  r"\1'https://raw.githubusercontent.com/zeroxm/pokemon-roulette-trainer-sprites/refs/heads/main/sprites/Spr_Masters_Florian_2.png'",
                  txt,
                  count=1
              )
              txt = re.sub(
                  r"(9\s*:\s*\{[\s\S]*?female\s*:\s*)'[^']*'",
                  r"\1'https://raw.githubusercontent.com/zeroxm/pokemon-roulette-trainer-sprites/refs/heads/main/sprites/Spr_Masters_Juliana.png'",
                  txt,
                  count=1
              )
              trainer.write_text(txt, encoding="utf-8")

          # ------------------------------------------------------------
          # (B) Bigger & sharper wheel on mobile (kept)
          # ------------------------------------------------------------
          wheel_ts = Path("src/app/wheel/wheel.component.ts")
          if wheel_ts.exists():
              txt = wheel_ts.read_text(encoding="utf-8")

              txt = re.sub(
                  r"this\.canvasHeight\s*=\s*Math\.minwindow\.innerHeight,\s*window\.innerWidth\s*\*\s*0\.50\s*;",
                  "const minDim = Math.min(window.innerHeight, window.innerWidth);\n"
                  "    const isMobile = window.innerWidth <= 768;\n"
                  "    this.canvasHeight = minDim * (isMobile ? 0.72 : 0.50);",
                  txt,
                  count=1
              )

              txt = txt.replace("const centerX = this.wheelCanvas.width / 2;", "const centerX = this.wheelWidth / 2;")
              txt = txt.replace("const centerY = this.wheelCanvas.height / 2;", "const centerY = this.canvasHeight / 2;")
              txt = txt.replace("const radius = (this.wheelCanvas.width / 2);", "const radius = (this.wheelWidth / 2);")
              txt = txt.replace(
                  "this.wheelCtx.clearRect(0, 0, this.wheelCanvas.width, this.wheelCanvas.height);",
                  "this.wheelCtx.clearRect(0, 0, this.wheelWidth, this.canvasHeight);"
              )

              txt = re.sub(
                  r"\n\s*drawPointer: void \{[\s\S]*?\n\s*\}\n\n\s*spinWheel\(",
                  "\n  drawPointer(): void {\n"
                  "    const midY = this.canvasHeight / 2;\n"
                  "    const xRight = this.cursorWidth - 2;\n"
                  "    const tipX = 2;\n\n"
                  "    this.pointerCtx.save();\n"
                  "    this.pointerCtx.lineWidth = 2;\n"
                  "    this.pointerCtx.strokeStyle = this.pointerStrokeColor;\n"
                  "    this.pointerCtx.fillStyle = this.pointerFillColor;\n"
                  "    this.pointerCtx.beginPath();\n"
                  "    this.pointerCtx.moveTo(xRight, midY - 20);\n"
                  "    this.pointerCtx.lineTo(xRight, midY + 20);\n"
                  "    this.pointerCtx.lineTo(tipX, midY);\n"
                  "    this.pointerCtx.closePath();\n"
                  "    this.pointerCtx.stroke();\n"
                  "    this.pointerCtx.fill();\n"
                  "    this.pointerCtx.restore();\n"
                  "  }\n\n"
                  "  spinWheel(",
                  txt,
                  count=1
              )

              if "setupHiDpiCanvases" not in txt:
                  marker = "this.pointerCtx = this.pointerCanvas.getContext('2d')!;"
                  if marker in txt and "this.setupHiDpiCanvases();" not in txt:
                      txt = txt.replace(marker, marker + "\n    this.setupHiDpiCanvases();", 1)

                  method = """
            private setupHiDpiCanvases(): void {
              const dpr = window.devicePixelRatio || 1;

              this.wheelCanvas.width = Math.floor(this.wheelWidth * dpr);
              this.wheelCanvas.height = Math.floor(this.canvasHeight * dpr);
              this.wheelCanvas.style.width = `${this.wheelWidth}px`;
              this.wheelCanvas.style.height = `${this.canvasHeight}px`;
              this.wheelCtx.setTransform(dpr, 0, 0, dpr, 0, 0);

              this.pointerCanvas.width = Math.floor(this.cursorWidth * dpr);
              this.pointerCanvas.height = Math.floor(this.canvasHeight * dpr);
              this.pointerCanvas.style.width = `${this.cursorWidth}px`;
              this.pointerCanvas.style.height = `${this.canvasHeight}px`;
              this.pointerCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
            }
          """
                  last = txt.rfind("}")
                  if last != -1:
                      txt = txt[:last] + method + "\n" + txt[last:]

              wheel_ts.write_text(txt, encoding="utf-8")

          wheel_css = Path("src/app/wheel/wheel.component.css")
          if wheel_css.exists():
              css = (
                  ".wheel-container{display:flex;flex-direction:column;align-items:center}\n"
                  ".wheel-container p{font-size:clamp(1.05rem,4.6vw,1.5rem);font-weight:700;text-align:center;"
                  "max-width:min(92vw,520px);padding:0 .75rem;line-height:1.2;overflow-wrap:anywhere;word-break:break-word;"
                  "margin:.5rem 0 0}\n"
                  ".canvas-container{display:flex;flex-direction:row;align-items:center;justify-content:center;margin-left:0}\n"
              )
              wheel_css.write_text(css, encoding="utf-8")

          # ------------------------------------------------------------
          # (C) Coffee page: remove international option, show PIX key, copy key
          #     Also generate public/qr_code.jpeg from PIX_KEY
          # ------------------------------------------------------------
          coffee_html = Path("src/app/coffee/coffee.component.html")
          if coffee_html.exists():
              txt = coffee_html.read_text(encoding="utf-8")

              # Remove Ko-fi / international block
              txt = re.sub(
                  r"\s*<div class=\"col-md-6 mt-md-0 mt-3\">[\s\S]*?</div>\s*",
                  "\n",
                  txt,
                  count=1
              )

              # Ensure PIX key appears under the QR image (Angular binding)
              img_line = '<img appImgFallback src="qr_code.jpeg" alt="PIX QR Code" style="height: 225px;" class="img-fluid" (click)="copyPixCode()">'
              if img_line in txt and "{{ pixKey }}" not in txt:
                  txt = txt.replace(
                      img_line,
                      img_line
                      + "\n                        <p class=\"mt-3 mb-1\"><strong>Chave PIX:</strong></p>\n"
                      + "                        <p class=\"mb-2\" style=\"word-break: break-all;\">{{ pixKey }}</p>"
                  )

              coffee_html.write_text(txt, encoding="utf-8")

          coffee_ts = Path("src/app/coffee/coffee.component.ts")
          if coffee_ts.exists():
              coffee_ts.write_text((
                  "import { Component } from '@angular/core';\n"
                  "import { NgIconsModule } from '@ng-icons/core';\n"
                  "import { MainGameButtonComponent } from \"../main-game-button/main-game-button.component\";\n"
                  "import { CommonModule } from '@angular/common';\n"
                  "import { TranslatePipe } from '@ngx-translate/core';\n"
                  "import { ImgFallbackDirective } from '../shared/img-fallback.directive';\n"
                  "import { CreditsButtonComponent } from \"../main-game/credits-button/credits-button.component\";\n"
                  "\n"
                  "@Component({\n"
                  "  selector: 'app-coffee',\n"
                  "  imports: [\n"
                  "    ImgFallbackDirective,\n"
                  "    CommonModule,\n"
                  "    NgIconsModule,\n"
                  "    MainGameButtonComponent,\n"
                  "    TranslatePipe,\n"
                  "    CreditsButtonComponent\n"
                  "  ],\n"
                  "  templateUrl: './coffee.component.html',\n"
                  "  styleUrl: './coffee.component.css'\n"
                  "})\n"
                  "export class CoffeeComponent {\n"
                  f"  readonly pixKey = '{PIX_KEY}';\n"
                  "  pixCodeCopied = false;\n"
                  "\n"
                  "  copyPixCode(): void {\n"
                  "    navigator.clipboard.writeText(this.pixKey).then(() => {\n"
                  "      this.pixCodeCopied = true;\n"
                  "      setTimeout(() => (this.pixCodeCopied = false), 2000);\n"
                  "    }).catch((err) => {\n"
                  "      console.error('Could not copy PIX key: ', err);\n"
                  "    });\n"
                  "  }\n"
                  "}\n"
              ), encoding="utf-8")

          # Generate QR PIX (EMV) into public/qr_code.jpeg
          def pip_install(pkg: str):
              subprocess.check_call([sys.executable, "-m", "pip", "install", "--quiet", pkg])

          try:
              import qrcode
          except Exception:
              pip_install("qrcode[pil]")
              import qrcode

          try:
              from PIL import Image
          except Exception:
              pip_install("pillow")
              from PIL import Image

          def crc16_ccitt(payload: str) -> str:
              crc = 0xFFFF
              for b in payload.encode("utf-8"):
                  crc ^= (b << 8)
                  for _ in range(8):
                      if crc & 0x8000:
                          crc = ((crc << 1) ^ 0x1021) & 0xFFFF
                      else:
                          crc = (crc << 1) & 0xFFFF
              return f"{crc:04X}"

          def tlv(tag: str, value: str) -> str:
              return f"{tag}{len(value):02d}{value}"

          # Merchant Account Information (26)
          gui = tlv("00", "BR.GOV.BCB.PIX")
          key = tlv("01", PIX_KEY)
          desc = tlv("02", "PokeRoleta")
          mai_26 = tlv("26", gui + key + desc)

          payload = ""
          payload += tlv("00", "01")          # Payload format indicator
          payload += tlv("01", "11")          # Static
          payload += mai_26
          payload += tlv("52", "0000")        # MCC
          payload += tlv("53", "986")         # BRL
          payload += tlv("58", "BR")          # Country
          payload += tlv("59", "POKEROLETA")  # Merchant name
          payload += tlv("60", "BRASIL")      # City
          payload += tlv("62", tlv("05", "POKEROLETA"))  # Reference label

          payload_for_crc = payload + "6304"
          payload = payload_for_crc + crc16_ccitt(payload_for_crc)

          qr = qrcode.QRCode(
              version=None,
              error_correction=qrcode.constants.ERROR_CORRECT_M,
              box_size=10,
              border=2,
          )
          qr.add_data(payload)
          qr.make(fit=True)
          img = qr.make_image(fill_color="black", back_color="white").convert("RGB")
          img = img.resize((530, 530), Image.NEAREST)

          out_qr = Path("public/qr_code.jpeg")
          out_qr.parent.mkdir(parents=True, exist_ok=True)
          img.save(out_qr, format="JPEG", quality=95)

          # ------------------------------------------------------------
          # (D) Evolution bug fix + regional rules + Hisui exception
          # - Fix freeze caused by entries like 211:[] (Qwilfish) and others.
          # - Non-regional base: blocks Alola/Galar/Paldea evolutions
          # - Allows Hisui evolutions (10229..10247) as exception
          # ------------------------------------------------------------
          evo_service = Path("src/app/services/evolution-service/evolution.service.ts")
          if evo_service.exists():
              evo_service.write_text(
                  "import { Injectable } from '@angular/core';\n"
                  "import { PokemonItem } from '../../interfaces/pokemon-item';\n"
                  "import { evolutionChain } from './evolution-chain';\n"
                  "import { PokemonService } from '../pokemon-service/pokemon.service';\n"
                  "\n"
                  "@Injectable({\n"
                  "  providedIn: 'root'\n"
                  "})\n"
                  "export class EvolutionService {\n"
                  "\n"
                  "  evolutionChain = evolutionChain;\n"
                  "\n"
                  "  constructor(private pokemonService: PokemonService) {}\n"
                  "\n"
                  "  /** Hisuian form IDs used in this project */\n"
                  "  private isHisuianFormId(id: number): boolean {\n"
                  "    return id >= 10229 && id <= 10247;\n"
                  "  }\n"
                  "\n"
                  "  /**\n"
                  "   * IMPORTANT FIX:\n"
                  "   * Some Pokémon were in evolutionChain as [] (empty), e.g. Qwilfish (211).\n"
                  "   * In JS/TS, [] is truthy, so the UI thought it could evolve and froze\n"
                  "   * when it had 0 options.\n"
                  "   */\n"
                  "  canEvolve(pokemon: PokemonItem): boolean {\n"
                  "    return this.getEvolutions(pokemon).length > 0;\n"
                  "  }\n"
                  "\n"
                  "  /**\n"
                  "   * Rules:\n"
                  "   * - If the base Pokémon is a regional form (has basePokemonId), it only evolves\n"
                  "   *   through its own chain.\n"
                  "   * - If the base Pokémon is NOT regional (no basePokemonId), it only evolves\n"
                  "   *   to non-regional evolutions, EXCEPT Hisui forms are allowed.\n"
                  "   */\n"
                  "  getEvolutions(pokemon: PokemonItem): PokemonItem[] {\n"
                  "    const chain = this.evolutionChain[pokemon.pokemonId];\n"
                  "    if (!chain || chain.length === 0) return [];\n"
                  "\n"
                  "    const evolutions: PokemonItem[] = chain\n"
                  "      .map((id) => this.pokemonService.getPokemonById(id))\n"
                  "      .filter((p): p is PokemonItem => !!p);\n"
                  "\n"
                  "    // Non-regional base: block regional evolutions (Alola/Galar/Paldea etc)\n"
                  "    // but allow Hisui (since Hisui isn't a selectable region in this game).\n"
                  "    if (!pokemon.basePokemonId) {\n"
                  "      return evolutions.filter((evo) => !evo.basePokemonId || this.isHisuianFormId(evo.pokemonId));\n"
                  "    }\n"
                  "\n"
                  "    // Regional base: keep chain as defined.\n"
                  "    return evolutions;\n"
                  "  }\n"
                  "}\n",
                  encoding="utf-8"
              )

          print("Patch OK: PIX-only + QR + evolution freeze fix + regional rules.")
          PY

      - name: Build (relative paths for GitHub Pages)
        working-directory: ${{ env.PROJECT_ROOT }}
        env:
          NODE_OPTIONS: --max_old_space_size=4096
        run: npm run build -- --configuration production --base-href "./" --deploy-url "./"

      - name: Locate index.html for Pages
        run: |
          set -e
          IDX="$(find "${{ env.PROJECT_ROOT }}/dist" -maxdepth 12 -type f -name index.html -print -quit)"
          if [ -z "$IDX" ]; then
            echo "ERROR: index.html not found in dist."
            exit 1
          fi
          PAGES_DIR="$(dirname "$IDX")"
          echo "PAGES_PATH=$PAGES_DIR" >> $GITHUB_ENV
          touch "$PAGES_DIR/.nojekyll"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.PAGES_PATH }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4name: Deploy to GitHub Pages (from zip)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

env:
  ZIP_FILE: pokemon-roulette-source.zip

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Unzip source
        run: |
          set -e
          if [ ! -f "${{ env.ZIP_FILE }}" ]; then
            echo "ERROR: zip '${{ env.ZIP_FILE }}' not found."
            ls -la *.zip || true
            exit 1
          fi
          rm -rf app
          mkdir -p app
          unzip -q "${{ env.ZIP_FILE }}" -d app
          ls -la app

      - name: Find project root (package.json)
        run: |
          set -e
          ROOT="$(find app -maxdepth 12 -name package.json -print -quit | xargs -r dirname)"
          if [ -z "$ROOT" ]; then
            echo "ERROR: package.json not found inside zip."
            exit 1
          fi
          echo "PROJECT_ROOT=$ROOT" >> $GITHUB_ENV
          ls -la "$ROOT"

      - name: Install dependencies
        working-directory: ${{ env.PROJECT_ROOT }}
        run: npm install --legacy-peer-deps

      - name: Install @angular/localize (match Angular version)
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          set -e
          CORE_VER=$(node -p "require('./package.json').dependencies?.['@angular/core'] || require('./package.json').devDependencies?.['@angular/core'] || ''")
          if [ -z "$CORE_VER" ]; then
            echo "ERROR: Could not detect @angular/core version from package.json"
            exit 1
          fi
          CORE_VER="${CORE_VER#^}"
          CORE_VER="${CORE_VER#~}"
          npm install @angular/localize@$CORE_VER --legacy-peer-deps

      - name: Patch (trainer Gen9 + wheel mobile + PIX only + evolution rules/fix)
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          set -e
          python3 - <<'PY'
          import re
          import subprocess
          import sys
          from pathlib import Path

          PIX_KEY = "f1f43bfc-b355-4102-b530-256a03241385"

          # ------------------------------------------------------------
          # (A) Guarantee Gen 9 trainer sprites (Florian / Juliana)
          # ------------------------------------------------------------
          trainer = Path("src/app/services/trainer-service/trainer-sprite-data.ts")
          if trainer.exists():
              txt = trainer.read_text(encoding="utf-8")

              # Force generation 9 male/female urls (robust)
              txt = re.sub(
                  r"(9\s*:\s*\{[\s\S]*?male\s*:\s*)'[^']*'",
                  r"\1'https://raw.githubusercontent.com/zeroxm/pokemon-roulette-trainer-sprites/refs/heads/main/sprites/Spr_Masters_Florian_2.png'",
                  txt,
                  count=1
              )
              txt = re.sub(
                  r"(9\s*:\s*\{[\s\S]*?female\s*:\s*)'[^']*'",
                  r"\1'https://raw.githubusercontent.com/zeroxm/pokemon-roulette-trainer-sprites/refs/heads/main/sprites/Spr_Masters_Juliana.png'",
                  txt,
                  count=1
              )
              trainer.write_text(txt, encoding="utf-8")

          # ------------------------------------------------------------
          # (B) Bigger & sharper wheel on mobile (kept)
          # ------------------------------------------------------------
          wheel_ts = Path("src/app/wheel/wheel.component.ts")
          if wheel_ts.exists():
              txt = wheel_ts.read_text(encoding="utf-8")

              txt = re.sub(
                  r"this\.canvasHeight\s*=\s*Math\.minwindow\.innerHeight,\s*window\.innerWidth\s*\*\s*0\.50\s*;",
                  "const minDim = Math.min(window.innerHeight, window.innerWidth);\n"
                  "    const isMobile = window.innerWidth <= 768;\n"
                  "    this.canvasHeight = minDim * (isMobile ? 0.72 : 0.50);",
                  txt,
                  count=1
              )

              txt = txt.replace("const centerX = this.wheelCanvas.width / 2;", "const centerX = this.wheelWidth / 2;")
              txt = txt.replace("const centerY = this.wheelCanvas.height / 2;", "const centerY = this.canvasHeight / 2;")
              txt = txt.replace("const radius = (this.wheelCanvas.width / 2);", "const radius = (this.wheelWidth / 2);")
              txt = txt.replace(
                  "this.wheelCtx.clearRect(0, 0, this.wheelCanvas.width, this.wheelCanvas.height);",
                  "this.wheelCtx.clearRect(0, 0, this.wheelWidth, this.canvasHeight);"
              )

              txt = re.sub(
                  r"\n\s*drawPointer: void \{[\s\S]*?\n\s*\}\n\n\s*spinWheel\(",
                  "\n  drawPointer(): void {\n"
                  "    const midY = this.canvasHeight / 2;\n"
                  "    const xRight = this.cursorWidth - 2;\n"
                  "    const tipX = 2;\n\n"
                  "    this.pointerCtx.save();\n"
                  "    this.pointerCtx.lineWidth = 2;\n"
                  "    this.pointerCtx.strokeStyle = this.pointerStrokeColor;\n"
                  "    this.pointerCtx.fillStyle = this.pointerFillColor;\n"
                  "    this.pointerCtx.beginPath();\n"
                  "    this.pointerCtx.moveTo(xRight, midY - 20);\n"
                  "    this.pointerCtx.lineTo(xRight, midY + 20);\n"
                  "    this.pointerCtx.lineTo(tipX, midY);\n"
                  "    this.pointerCtx.closePath();\n"
                  "    this.pointerCtx.stroke();\n"
                  "    this.pointerCtx.fill();\n"
                  "    this.pointerCtx.restore();\n"
                  "  }\n\n"
                  "  spinWheel(",
                  txt,
                  count=1
              )

              if "setupHiDpiCanvases" not in txt:
                  marker = "this.pointerCtx = this.pointerCanvas.getContext('2d')!;"
                  if marker in txt and "this.setupHiDpiCanvases();" not in txt:
                      txt = txt.replace(marker, marker + "\n    this.setupHiDpiCanvases();", 1)

                  method = """
            private setupHiDpiCanvases(): void {
              const dpr = window.devicePixelRatio || 1;

              this.wheelCanvas.width = Math.floor(this.wheelWidth * dpr);
              this.wheelCanvas.height = Math.floor(this.canvasHeight * dpr);
              this.wheelCanvas.style.width = `${this.wheelWidth}px`;
              this.wheelCanvas.style.height = `${this.canvasHeight}px`;
              this.wheelCtx.setTransform(dpr, 0, 0, dpr, 0, 0);

              this.pointerCanvas.width = Math.floor(this.cursorWidth * dpr);
              this.pointerCanvas.height = Math.floor(this.canvasHeight * dpr);
              this.pointerCanvas.style.width = `${this.cursorWidth}px`;
              this.pointerCanvas.style.height = `${this.canvasHeight}px`;
              this.pointerCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
            }
          """
                  last = txt.rfind("}")
                  if last != -1:
                      txt = txt[:last] + method + "\n" + txt[last:]

              wheel_ts.write_text(txt, encoding="utf-8")

          wheel_css = Path("src/app/wheel/wheel.component.css")
          if wheel_css.exists():
              css = (
                  ".wheel-container{display:flex;flex-direction:column;align-items:center}\n"
                  ".wheel-container p{font-size:clamp(1.05rem,4.6vw,1.5rem);font-weight:700;text-align:center;"
                  "max-width:min(92vw,520px);padding:0 .75rem;line-height:1.2;overflow-wrap:anywhere;word-break:break-word;"
                  "margin:.5rem 0 0}\n"
                  ".canvas-container{display:flex;flex-direction:row;align-items:center;justify-content:center;margin-left:0}\n"
              )
              wheel_css.write_text(css, encoding="utf-8")

          # ------------------------------------------------------------
          # (C) Coffee page: remove international option, show PIX key, copy key
          #     Also generate public/qr_code.jpeg from PIX_KEY
          # ------------------------------------------------------------
          coffee_html = Path("src/app/coffee/coffee.component.html")
          if coffee_html.exists():
              txt = coffee_html.read_text(encoding="utf-8")

              # Remove Ko-fi / international block
              txt = re.sub(
                  r"\s*<div class=\"col-md-6 mt-md-0 mt-3\">[\s\S]*?</div>\s*",
                  "\n",
                  txt,
                  count=1
              )

              # Ensure PIX key appears under the QR image (Angular binding)
              img_line = '<img appImgFallback src="qr_code.jpeg" alt="PIX QR Code" style="height: 225px;" class="img-fluid" (click)="copyPixCode()">'
              if img_line in txt and "{{ pixKey }}" not in txt:
                  txt = txt.replace(
                      img_line,
                      img_line
                      + "\n                        <p class=\"mt-3 mb-1\"><strong>Chave PIX:</strong></p>\n"
                      + "                        <p class=\"mb-2\" style=\"word-break: break-all;\">{{ pixKey }}</p>"
                  )

              coffee_html.write_text(txt, encoding="utf-8")

          coffee_ts = Path("src/app/coffee/coffee.component.ts")
          if coffee_ts.exists():
              coffee_ts.write_text((
                  "import { Component } from '@angular/core';\n"
                  "import { NgIconsModule } from '@ng-icons/core';\n"
                  "import { MainGameButtonComponent } from \"../main-game-button/main-game-button.component\";\n"
                  "import { CommonModule } from '@angular/common';\n"
                  "import { TranslatePipe } from '@ngx-translate/core';\n"
                  "import { ImgFallbackDirective } from '../shared/img-fallback.directive';\n"
                  "import { CreditsButtonComponent } from \"../main-game/credits-button/credits-button.component\";\n"
                  "\n"
                  "@Component({\n"
                  "  selector: 'app-coffee',\n"
                  "  imports: [\n"
                  "    ImgFallbackDirective,\n"
                  "    CommonModule,\n"
                  "    NgIconsModule,\n"
                  "    MainGameButtonComponent,\n"
                  "    TranslatePipe,\n"
                  "    CreditsButtonComponent\n"
                  "  ],\n"
                  "  templateUrl: './coffee.component.html',\n"
                  "  styleUrl: './coffee.component.css'\n"
                  "})\n"
                  "export class CoffeeComponent {\n"
                  f"  readonly pixKey = '{PIX_KEY}';\n"
                  "  pixCodeCopied = false;\n"
                  "\n"
                  "  copyPixCode(): void {\n"
                  "    navigator.clipboard.writeText(this.pixKey).then(() => {\n"
                  "      this.pixCodeCopied = true;\n"
                  "      setTimeout(() => (this.pixCodeCopied = false), 2000);\n"
                  "    }).catch((err) => {\n"
                  "      console.error('Could not copy PIX key: ', err);\n"
                  "    });\n"
                  "  }\n"
                  "}\n"
              ), encoding="utf-8")

          # Generate QR PIX (EMV) into public/qr_code.jpeg
          def pip_install(pkg: str):
              subprocess.check_call([sys.executable, "-m", "pip", "install", "--quiet", pkg])

          try:
              import qrcode
          except Exception:
              pip_install("qrcode[pil]")
              import qrcode

          try:
              from PIL import Image
          except Exception:
              pip_install("pillow")
              from PIL import Image

          def crc16_ccitt(payload: str) -> str:
              crc = 0xFFFF
              for b in payload.encode("utf-8"):
                  crc ^= (b << 8)
                  for _ in range(8):
                      if crc & 0x8000:
                          crc = ((crc << 1) ^ 0x1021) & 0xFFFF
                      else:
                          crc = (crc << 1) & 0xFFFF
              return f"{crc:04X}"

          def tlv(tag: str, value: str) -> str:
              return f"{tag}{len(value):02d}{value}"

          # Merchant Account Information (26)
          gui = tlv("00", "BR.GOV.BCB.PIX")
          key = tlv("01", PIX_KEY)
          desc = tlv("02", "PokeRoleta")
          mai_26 = tlv("26", gui + key + desc)

          payload = ""
          payload += tlv("00", "01")          # Payload format indicator
          payload += tlv("01", "11")          # Static
          payload += mai_26
          payload += tlv("52", "0000")        # MCC
          payload += tlv("53", "986")         # BRL
          payload += tlv("58", "BR")          # Country
          payload += tlv("59", "POKEROLETA")  # Merchant name
          payload += tlv("60", "BRASIL")      # City
          payload += tlv("62", tlv("05", "POKEROLETA"))  # Reference label

          payload_for_crc = payload + "6304"
          payload = payload_for_crc + crc16_ccitt(payload_for_crc)

          qr = qrcode.QRCode(
              version=None,
              error_correction=qrcode.constants.ERROR_CORRECT_M,
              box_size=10,
              border=2,
          )
          qr.add_data(payload)
          qr.make(fit=True)
          img = qr.make_image(fill_color="black", back_color="white").convert("RGB")
          img = img.resize((530, 530), Image.NEAREST)

          out_qr = Path("public/qr_code.jpeg")
          out_qr.parent.mkdir(parents=True, exist_ok=True)
          img.save(out_qr, format="JPEG", quality=95)

          # ------------------------------------------------------------
          # (D) Evolution bug fix + regional rules + Hisui exception
          # - Fix freeze caused by entries like 211:[] (Qwilfish) and others.
          # - Non-regional base: blocks Alola/Galar/Paldea evolutions
          # - Allows Hisui evolutions (10229..10247) as exception
          # ------------------------------------------------------------
          evo_service = Path("src/app/services/evolution-service/evolution.service.ts")
          if evo_service.exists():
              evo_service.write_text(
                  "import { Injectable } from '@angular/core';\n"
                  "import { PokemonItem } from '../../interfaces/pokemon-item';\n"
                  "import { evolutionChain } from './evolution-chain';\n"
                  "import { PokemonService } from '../pokemon-service/pokemon.service';\n"
                  "\n"
                  "@Injectable({\n"
                  "  providedIn: 'root'\n"
                  "})\n"
                  "export class EvolutionService {\n"
                  "\n"
                  "  evolutionChain = evolutionChain;\n"
                  "\n"
                  "  constructor(private pokemonService: PokemonService) {}\n"
                  "\n"
                  "  /** Hisuian form IDs used in this project */\n"
                  "  private isHisuianFormId(id: number): boolean {\n"
                  "    return id >= 10229 && id <= 10247;\n"
                  "  }\n"
                  "\n"
                  "  /**\n"
                  "   * IMPORTANT FIX:\n"
                  "   * Some Pokémon were in evolutionChain as [] (empty), e.g. Qwilfish (211).\n"
                  "   * In JS/TS, [] is truthy, so the UI thought it could evolve and froze\n"
                  "   * when it had 0 options.\n"
                  "   */\n"
                  "  canEvolve(pokemon: PokemonItem): boolean {\n"
                  "    return this.getEvolutions(pokemon).length > 0;\n"
                  "  }\n"
                  "\n"
                  "  /**\n"
                  "   * Rules:\n"
                  "   * - If the base Pokémon is a regional form (has basePokemonId), it only evolves\n"
                  "   *   through its own chain.\n"
                  "   * - If the base Pokémon is NOT regional (no basePokemonId), it only evolves\n"
                  "   *   to non-regional evolutions, EXCEPT Hisui forms are allowed.\n"
                  "   */\n"
                  "  getEvolutions(pokemon: PokemonItem): PokemonItem[] {\n"
                  "    const chain = this.evolutionChain[pokemon.pokemonId];\n"
                  "    if (!chain || chain.length === 0) return [];\n"
                  "\n"
                  "    const evolutions: PokemonItem[] = chain\n"
                  "      .map((id) => this.pokemonService.getPokemonById(id))\n"
                  "      .filter((p): p is PokemonItem => !!p);\n"
                  "\n"
                  "    // Non-regional base: block regional evolutions (Alola/Galar/Paldea etc)\n"
                  "    // but allow Hisui (since Hisui isn't a selectable region in this game).\n"
                  "    if (!pokemon.basePokemonId) {\n"
                  "      return evolutions.filter((evo) => !evo.basePokemonId || this.isHisuianFormId(evo.pokemonId));\n"
                  "    }\n"
                  "\n"
                  "    // Regional base: keep chain as defined.\n"
                  "    return evolutions;\n"
                  "  }\n"
                  "}\n",
                  encoding="utf-8"
              )

          print("Patch OK: PIX-only + QR + evolution freeze fix + regional rules.")
          PY

      - name: Build (relative paths for GitHub Pages)
        working-directory: ${{ env.PROJECT_ROOT }}
        env:
          NODE_OPTIONS: --max_old_space_size=4096
        run: npm run build -- --configuration production --base-href "./" --deploy-url "./"

      - name: Locate index.html for Pages
        run: |
          set -e
          IDX="$(find "${{ env.PROJECT_ROOT }}/dist" -maxdepth 12 -type f -name index.html -print -quit)"
          if [ -z "$IDX" ]; then
            echo "ERROR: index.html not found in dist."
            exit 1
          fi
          PAGES_DIR="$(dirname "$IDX")"
          echo "PAGES_PATH=$PAGES_DIR" >> $GITHUB_ENV
          touch "$PAGES_DIR/.nojekyll"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.PAGES_PATH }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
