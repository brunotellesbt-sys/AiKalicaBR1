name: Deploy to GitHub Pages (from zip)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

env:
  ZIP_FILE: pokemon-roulette-source.zip

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Unzip source
        run: |
          set -e
          if [ ! -f "${{ env.ZIP_FILE }}" ]; then
            echo "ERROR: zip '${{ env.ZIP_FILE }}' not found."
            ls -la *.zip || true
            exit 1
          fi
          rm -rf app
          mkdir -p app
          unzip -q "${{ env.ZIP_FILE }}" -d app
          ls -la app

      - name: Find project root (package.json)
        run: |
          set -e
          ROOT="$(find app -maxdepth 12 -name package.json -print -quit | xargs -r dirname)"
          if [ -z "$ROOT" ]; then
            echo "ERROR: package.json not found inside zip."
            exit 1
          fi
          echo "PROJECT_ROOT=$ROOT" >> $GITHUB_ENV
          ls -la "$ROOT"

      - name: Install dependencies
        working-directory: ${{ env.PROJECT_ROOT }}
        run: npm install --legacy-peer-deps

      - name: Install @angular/localize (match Angular version)
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          set -e
          CORE_VER=$(node -p "require('./package.json').dependencies?.['@angular/core'] || require('./package.json').devDependencies?.['@angular/core'] || ''")
          if [ -z "$CORE_VER" ]; then
            echo "ERROR: Could not detect @angular/core version from package.json"
            exit 1
          fi
          CORE_VER="${CORE_VER#^}"
          CORE_VER="${CORE_VER#~}"
          npm install @angular/localize@$CORE_VER --legacy-peer-deps

      - name: Patch (wheel bigger & sharper + mega evo popup fixed + mega SFX/cries + Gen 9 trainers)
        working-directory: ${{ env.PROJECT_ROOT }}
        run: |
          set -e

          # --- Gen 9 trainer sprites: bundle locally (no hotlink) ---
          mkdir -p src/assets/trainers
          curl -L --retry 3 --fail "https://archives.bulbagarden.net/media/upload/6/62/Spr_Masters_Florian_2.png" -o "src/assets/trainers/Spr_Masters_Florian_2.png"
          curl -L --retry 3 --fail "https://archives.bulbagarden.net/media/upload/4/4a/Spr_Masters_Juliana.png" -o "src/assets/trainers/Spr_Masters_Juliana.png"

          python3 - <<'PY'
          import re
          import textwrap
          from pathlib import Path

          def safe_write(path: Path, text: str):
              path.parent.mkdir(parents=True, exist_ok=True)
              path.write_text(text, encoding="utf-8")

          def replace_method_ts(src: str, method_name: str, new_block: str) -> str:
              m = re.search(
                  rf"(^\s*(public|private|protected)?\s*(async\s+)?{re.escape(method_name)}\s*\([^)]*\)\s*(?::\s*[^\n]+)?\s*\{{)",
                  src,
                  flags=re.MULTILINE
              )
              if not m:
                  return src
              start = m.start(1)
              brace_start = src.find("{", m.end(1) - 1)
              if brace_start == -1:
                  return src
              depth = 0
              end = None
              for i in range(brace_start, len(src)):
                  if src[i] == "{":
                      depth += 1
                  elif src[i] == "}":
                      depth -= 1
                      if depth == 0:
                          end = i + 1
                          break
              if end is None:
                  return src
              return src[:start] + new_block.rstrip() + "\n" + src[end:]

          # ----------------------------
          # Trainer sprites (Gen 9)
          # ----------------------------
          trainer = Path("src/app/services/trainer-service/trainer-sprite-data.ts")
          if trainer.exists():
              txt = trainer.read_text(encoding="utf-8")
              txt = txt.replace(
                  "https://archives.bulbagarden.net/media/upload/6/62/Spr_Masters_Florian_2.png",
                  "assets/trainers/Spr_Masters_Florian_2.png"
              )
              txt = txt.replace(
                  "https://archives.bulbagarden.net/media/upload/4/4a/Spr_Masters_Juliana.png",
                  "assets/trainers/Spr_Masters_Juliana.png"
              )
              safe_write(trainer, txt)

          # ----------------------------
          # Wheel: bigger on mobile + HiDPI sharp + pointer stable
          # ----------------------------
          wheel_ts = Path("src/app/wheel/wheel.component.ts")
          wheel_html = Path("src/app/wheel/wheel.component.html")
          wheel_css = Path("src/app/wheel/wheel.component.css")

          if wheel_ts.exists():
              w = wheel_ts.read_text(encoding="utf-8")

              w = re.sub(r"\bcanvasHeight:\s*number\s*;", "canvasHeight: number = 0;", w)
              w = re.sub(r"\bwheelWidth:\s*number\s*;", "wheelWidth: number = 0;", w)
              w = re.sub(r"\bcursorWidth:\s*number\s*;", "cursorWidth: number = 0;", w)
              w = re.sub(r"\bfontSize:\s*number\s*;", "fontSize: number = 0;", w)

              w = w.replace(
                  "import { AfterViewInit, Component, ElementRef, EventEmitter, Input, OnChanges, Output, SimpleChanges, ViewChild } from '@angular/core';",
                  "import { AfterViewInit, Component, ElementRef, EventEmitter, Input, OnChanges, Output, SimpleChanges, ViewChild, OnDestroy } from '@angular/core';"
              )
              w = w.replace(
                  "export class WheelComponent implements AfterViewInit, OnChanges {",
                  "export class WheelComponent implements AfterViewInit, OnChanges, OnDestroy {"
              )

              w = re.sub(
                  r"this\.canvasHeight\s*=\s*Math\.min\(window\.innerHeight,\s*window\.innerWidth\)\s*\*\s*0\.\d+\s*;\s*"
                  r"this\.wheelWidth\s*=\s*this\.canvasHeight\s*;\s*"
                  r"this\.cursorWidth\s*=\s*40\s*;\s*"
                  r"this\.fontSize\s*=\s*this\.wheelWidth\s*/\s*24\s*;",
                  "const minDim = Math.min(window.innerHeight, window.innerWidth);\n"
                  "    const isMobile = window.innerWidth <= 768;\n"
                  "    this.canvasHeight = minDim * (isMobile ? 0.78 : 0.55);\n"
                  "    this.wheelWidth = this.canvasHeight;\n"
                  "    this.cursorWidth = isMobile ? 48 : 40;\n"
                  "    this.fontSize = this.wheelWidth / 24;",
                  w,
                  count=1
              )

              if "private readonly onResize" not in w:
                  anchor = "  private cursorCanvas: HTMLCanvasElement;\n\n"
                  if anchor in w:
                      w = w.replace(
                          anchor,
                          anchor +
                          "  private readonly onResize = () => {\n"
                          "    const minDim = Math.min(window.innerHeight, window.innerWidth);\n"
                          "    const isMobile = window.innerWidth <= 768;\n"
                          "    this.canvasHeight = minDim * (isMobile ? 0.78 : 0.55);\n"
                          "    this.wheelWidth = this.canvasHeight;\n"
                          "    this.cursorWidth = isMobile ? 48 : 40;\n"
                          "    this.fontSize = this.wheelWidth / 24;\n"
                          "    this.setupHiDpiCanvases();\n"
                          "    this.drawWheel(this.spinning ? this.currentRotation : 0);\n"
                          "    this.drawPointer();\n"
                          "  };\n\n"
                      )

              if "setupHiDpiCanvases" not in w:
                  helper = textwrap.dedent("""\
                      private setupHiDpiCanvases(): void {
                        const dpr = window.devicePixelRatio || 1;

                        this.wheelCanvas.width = Math.floor(this.wheelWidth * dpr);
                        this.wheelCanvas.height = Math.floor(this.wheelWidth * dpr);
                        this.wheelCanvas.style.width = `${this.wheelWidth}px`;
                        this.wheelCanvas.style.height = `${this.wheelWidth}px`;
                        this.wheelCtx.setTransform(dpr, 0, 0, dpr, 0, 0);

                        this.pointerCanvas.width = Math.floor(this.cursorWidth * dpr);
                        this.pointerCanvas.height = Math.floor(this.wheelWidth * dpr);
                        this.pointerCanvas.style.width = `${this.cursorWidth}px`;
                        this.pointerCanvas.style.height = `${this.wheelWidth}px`;
                        this.pointerCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
                      }

                      ngOnDestroy(): void {
                        window.removeEventListener('resize', this.onResize as any);
                      }
                  """)
                  last = w.rfind("}")
                  w = w[:last] + "\n\n  " + helper.replace("\n", "\n  ").rstrip() + "\n" + w[last:]

              if "window.addEventListener('resize', this.onResize" not in w:
                  w = w.replace(
                      "    if (!this.wheelCtx || !this.pointerCtx) {\n      return;\n    }\n\n    this.drawPointer();",
                      "    if (!this.wheelCtx || !this.pointerCtx) {\n      return;\n    }\n\n    this.setupHiDpiCanvases();\n    window.addEventListener('resize', this.onResize, { passive: true });\n\n    this.drawPointer();"
                  )

              w = w.replace("const centerX = this.wheelCanvas.width / 2;", "const centerX = this.wheelWidth / 2;")
              w = w.replace("const centerY = this.wheelCanvas.height / 2;", "const centerY = this.wheelWidth / 2;")
              w = w.replace("const radius = (this.wheelCanvas.width / 2);", "const radius = (this.wheelWidth / 2);")
              w = w.replace(
                  "this.wheelCtx.clearRect(0, 0, this.wheelCanvas.width, this.wheelCanvas.height);",
                  "this.wheelCtx.clearRect(0, 0, this.wheelWidth, this.wheelWidth);"
              )

              w = re.sub(
                  r"drawPointer\(\): void \{[\s\S]*?\n\s*\}",
                  textwrap.dedent("""\
                      drawPointer(): void {
                        const midY = this.wheelWidth / 2;
                        const xRight = this.cursorWidth - 2;
                        const tipX = 2;

                        this.pointerCtx.save();
                        this.pointerCtx.clearRect(0, 0, this.cursorWidth, this.wheelWidth);
                        this.pointerCtx.lineWidth = 2;
                        this.pointerCtx.strokeStyle = this.pointerStrokeColor;
                        this.pointerCtx.fillStyle = this.pointerFillColor;
                        this.pointerCtx.beginPath();
                        this.pointerCtx.moveTo(xRight, midY - 20);
                        this.pointerCtx.lineTo(xRight, midY + 20);
                        this.pointerCtx.lineTo(tipX, midY);
                        this.pointerCtx.closePath();
                        this.pointerCtx.stroke();
                        this.pointerCtx.fill();
                        this.pointerCtx.restore();
                      }
                  """).rstrip(),
                  w,
                  count=1
              )

              safe_write(wheel_ts, w)

          if wheel_html.exists():
              h = wheel_html.read_text(encoding="utf-8")
              h = h.replace('[width]="wheelWidth"', '[style.width.px]="wheelWidth"')
              h = h.replace('[height]="wheelWidth"', '[style.height.px]="wheelWidth"')
              h = h.replace('[width]="cursorWidth"', '[style.width.px]="cursorWidth"')
              h = h.replace('[height]="wheelWidth"', '[style.height.px]="wheelWidth"')
              safe_write(wheel_html, h)

          if wheel_css.exists():
              safe_write(
                  wheel_css,
                  ".wheel-container{display:flex;flex-direction:column;align-items:center;width:100%}\n"
                  ".wheel-container p{font-size:clamp(1.05rem,4.6vw,1.5rem);font-weight:700;text-align:center;max-width:min(92vw,520px);padding:0 .75rem;line-height:1.2;overflow-wrap:anywhere;word-break:break-word;margin:.5rem 0 0}\n"
                  ".canvas-container{display:flex;flex-direction:row;align-items:center;justify-content:center;margin-left:0;width:100%}\n"
                  "#wheel{touch-action:manipulation}\n"
              )

          # ----------------------------
          # Mega Evolution roulette: fix before->after + add animation + sounds/cries
          # ----------------------------
          mega_ts = Path("src/app/main-game/roulette-container/roulettes/mega-evolution-roulette/mega-evolution-roulette.component.ts")
          mega_html = Path("src/app/main-game/roulette-container/roulettes/mega-evolution-roulette/mega-evolution-roulette.component.html")
          mega_css = Path("src/app/main-game/roulette-container/roulettes/mega-evolution-roulette/mega-evolution-roulette.component.css")

          if mega_ts.exists():
              t = mega_ts.read_text(encoding="utf-8")

              t = t.replace("import {NgIf} from '@angular/common';", "import {NgIf, NgClass} from '@angular/common';")
              t = re.sub(
                  r"imports:\s*\[([^\]]*)\]",
                  lambda m: ("imports: [" + (m.group(1).strip() + ", NgClass" if "NgClass" not in m.group(1) else m.group(1).strip()) + "]"),
                  t,
                  count=1
              )

              if "isMegaAnimating" not in t:
                  t = t.replace(
                      "  popupAfterName = '';\n",
                      "  popupAfterName = '';\n"
                      "  popupAfterApiName = '';\n"
                      "  isMegaAnimating = false;\n"
                      "  typeClass = 'type-normal';\n"
                      "  private timers: number[] = [];\n"
                      "  private cryAudio?: HTMLAudioElement;\n"
                      "  private audioCtx?: AudioContext;\n"
                      "  private static showdownDexPromise: Promise<Record<string, { types?: string[] }>> | null = null;\n"
                  )

              t = replace_method_ts(t, "applyMegaEvolution", textwrap.dedent("""\
                  private applyMegaEvolution(pokemon: PokemonItem, megaForm: MegaForm) {
                    this.popupBeforePokemon = {
                      ...pokemon,
                      sprite: pokemon.sprite ? { ...pokemon.sprite } : pokemon.sprite
                    } as PokemonItem;

                    this.popupAfterName = megaForm.displayName;
                    this.popupAfterApiName = megaForm.apiName;

                    const sub = this.megaEvolutionService.megaEvolveForBattle(pokemon, megaForm).subscribe({
                      next: () => {
                        this.openMegaPopupAndProceed();
                      },
                      error: () => this.megaEvolutionFinished.emit()
                    });

                    this.subs.add(sub);
                  }
              """))

              t = replace_method_ts(t, "openMegaPopupAndProceed", textwrap.dedent("""\
                  private openMegaPopupAndProceed() {
                    const ref = this.modalService.open(this.megaPopup, {
                      centered: true,
                      backdrop: 'static',
                      keyboard: false
                    });

                    this.isMegaAnimating = true;
                    this.setTypeClassFromShowdown(this.popupAfterApiName);
                    this.playMegaEvolutionSfx();

                    this.timers.push(window.setTimeout(() => {
                      this.playCryForMega(this.popupAfterApiName, this.popupAfterName);
                    }, 900));

                    this.timers.push(window.setTimeout(() => {
                      try { ref.close(); } catch {}
                    }, 2200));

                    ref.result.then(
                      () => this.megaEvolutionFinished.emit(),
                      () => this.megaEvolutionFinished.emit()
                    ).finally(() => {
                      this.isMegaAnimating = false;
                      this.stopCry();
                      this.clearTimers();
                    });
                  }
              """))

              t = replace_method_ts(t, "ngOnDestroy", textwrap.dedent("""\
                  ngOnDestroy(): void {
                    this.subs.unsubscribe();
                    if (this.modalRef) {
                      try { this.modalRef.close(); } catch {}
                    }
                    this.stopCry();
                    this.clearTimers();
                    try { this.audioCtx?.close(); } catch {}
                  }
              """))

              if "playMegaEvolutionSfx" not in t:
                  helpers = textwrap.dedent("""\
                      private playMegaEvolutionSfx(): void {
                        try {
                          if (!this.audioCtx) {
                            this.audioCtx = new (window.AudioContext || (window as any).webkitAudioContext)();
                          }
                          const ctx = this.audioCtx;
                          if (ctx.state === 'suspended') ctx.resume().catch(() => {});

                          const now = ctx.currentTime;

                          const osc = ctx.createOscillator();
                          osc.type = 'sawtooth';
                          osc.frequency.setValueAtTime(220, now);
                          osc.frequency.exponentialRampToValueAtTime(1200, now + 0.55);

                          const gain = ctx.createGain();
                          gain.gain.setValueAtTime(0.0001, now);
                          gain.gain.exponentialRampToValueAtTime(0.16, now + 0.08);
                          gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.75);

                          const bufferSize = Math.floor(ctx.sampleRate * 0.5);
                          const noiseBuffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                          const out = noiseBuffer.getChannelData(0);
                          for (let i = 0; i < bufferSize; i++) out[i] = (Math.random() * 2 - 1) * (1 - i / bufferSize);

                          const noise = ctx.createBufferSource();
                          noise.buffer = noiseBuffer;

                          const bandpass = ctx.createBiquadFilter();
                          bandpass.type = 'bandpass';
                          bandpass.frequency.setValueAtTime(800, now);
                          bandpass.frequency.linearRampToValueAtTime(1400, now + 0.4);

                          const noiseGain = ctx.createGain();
                          noiseGain.gain.setValueAtTime(0.0001, now);
                          noiseGain.gain.exponentialRampToValueAtTime(0.12, now + 0.08);
                          noiseGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.55);

                          osc.connect(gain);
                          noise.connect(bandpass);
                          bandpass.connect(noiseGain);

                          gain.connect(ctx.destination);
                          noiseGain.connect(ctx.destination);

                          osc.start(now);
                          noise.start(now);

                          osc.stop(now + 0.8);
                          noise.stop(now + 0.6);
                        } catch {}
                      }

                      private playCryForMega(apiName: string, fallbackName: string): void {
                        const id = this.toShowdownCryId(apiName || fallbackName);
                        const url = `https://play.pokemonshowdown.com/audio/cries/${id}.mp3`;

                        this.stopCry();

                        const audio = new Audio();
                        audio.preload = 'auto';
                        audio.src = url;
                        audio.volume = 0.9;

                        audio.onerror = () => {
                          const base = id.split('-mega')[0];
                          if (base && base !== id) {
                            audio.src = `https://play.pokemonshowdown.com/audio/cries/${base}.mp3`;
                            audio.play().catch(() => {});
                          }
                        };

                        audio.play().catch(() => {});
                        this.cryAudio = audio;
                      }

                      private stopCry(): void {
                        if (this.cryAudio) {
                          try {
                            this.cryAudio.pause();
                            this.cryAudio.currentTime = 0;
                          } catch {}
                        }
                        this.cryAudio = undefined;
                      }

                      private clearTimers(): void {
                        this.timers.forEach(t => clearTimeout(t));
                        this.timers = [];
                      }

                      private toShowdownCryId(nameOrApi: string): string {
                        let s = (nameOrApi || '').trim().toLowerCase();
                        s = s.replace(/\\s+/g, '-');
                        s = s.replace(/[^a-z0-9\\-]/g, '');
                        s = s.replace(/-mega-x\\b/g, '-megax').replace(/-mega-y\\b/g, '-megay');
                        return s;
                      }

                      private async setTypeClassFromShowdown(nameOrApi: string): Promise<void> {
                        try {
                          const dex = await this.getShowdownDex();
                          const toId = (x: string) => (x || '').toLowerCase().replace(/[^a-z0-9]+/g, '');
                          const key = toId(nameOrApi);
                          const entry = dex[key] || dex[toId(this.toShowdownCryId(nameOrApi))];
                          const t = entry?.types?.[0] || 'Normal';
                          this.typeClass = `type-${t.toLowerCase()}`;
                        } catch {
                          this.typeClass = 'type-normal';
                        }
                      }

                      private async getShowdownDex(): Promise<Record<string, { types?: string[] }>> {
                        if (!MegaEvolutionRouletteComponent.showdownDexPromise) {
                          MegaEvolutionRouletteComponent.showdownDexPromise =
                            fetch('https://play.pokemonshowdown.com/data/pokedex.json').then(r => r.json());
                        }
                        return MegaEvolutionRouletteComponent.showdownDexPromise;
                      }
                  """)
                  last = t.rfind("}")
                  t = t[:last] + "\n\n  " + helpers.replace("\n", "\n  ").rstrip() + "\n" + t[last:]

              safe_write(mega_ts, t)

          if mega_html.exists():
              h = mega_html.read_text(encoding="utf-8")
              if "[ngClass]" not in h:
                  h = h.replace(
                      '<div class="evolution-panel">',
                      '<div class="evolution-panel" [ngClass]="[typeClass, isMegaAnimating ? \'animating\' : \'\']">'
                  )
              if 'class="particles"' not in h:
                  h = h.replace(
                      '<div class="evolution-panel" [ngClass]="[typeClass, isMegaAnimating ? \'animating\' : \'\']">',
                      '<div class="evolution-panel" [ngClass]="[typeClass, isMegaAnimating ? \'animating\' : \'\']">\n      <div class="particles" aria-hidden="true"></div>'
                  )
              h = re.sub(r'<div class="pokemon">', '<div class="pokemon before">', h, count=1)
              h = re.sub(r'<div class="pokemon">', '<div class="pokemon after">', h, count=1)
              safe_write(mega_html, h)

          if mega_css.exists():
              css = mega_css.read_text(encoding="utf-8")
              if "/* mega-transform */" not in css:
                  addon = textwrap.dedent("""\
                      \n\n                      /* mega-transform */
                      .evolution-panel{position:relative;overflow:hidden}
                      .particles{position:absolute;inset:-10%;pointer-events:none;opacity:0;transition:opacity .2s ease;z-index:0}
                      .particles::before{content:'';position:absolute;inset:0;opacity:.9}
                      .pokemon{position:relative;z-index:1}
                      .pokemon.before img.sprite{will-change:transform,opacity,filter}
                      .pokemon.after img.sprite{will-change:transform,opacity,filter}
                      .evolution-panel.animating .pokemon.before img.sprite{animation:megaBefore .85s ease-in-out forwards}
                      .evolution-panel.animating .pokemon.after img.sprite{animation:megaAfter .85s ease-in-out forwards}
                      .evolution-panel.animating .particles{opacity:1;animation:particleMove .9s ease-out forwards}
                      @keyframes megaBefore{0%{opacity:1;transform:scale(1);filter:brightness(1)}45%{opacity:1;transform:scale(1.02);filter:brightness(1.7)}100%{opacity:0;transform:scale(1.1);filter:brightness(1.2) blur(2px)}}
                      @keyframes megaAfter{0%{opacity:0;transform:scale(.92);filter:brightness(2.2) blur(2px)}60%{opacity:1;transform:scale(1.06);filter:brightness(1.25)}100%{opacity:1;transform:scale(1);filter:brightness(1.05)}}
                      @keyframes particleMove{from{transform:translateY(18%) scale(.98)}to{transform:translateY(-20%) scale(1.02)}}
                      .type-water .particles::before{background-image:radial-gradient(circle at 15% 80%, rgba(200,240,255,.95) 0 2px, transparent 3px),radial-gradient(circle at 45% 90%, rgba(200,240,255,.95) 0 3px, transparent 4px),radial-gradient(circle at 75% 85%, rgba(200,240,255,.95) 0 2px, transparent 3px);background-size:24px 24px}
                      .type-fire .particles::before{background-image:radial-gradient(circle at 20% 80%, rgba(255,190,120,.95) 0 2px, transparent 3px),radial-gradient(circle at 55% 90%, rgba(255,150,90,.9) 0 3px, transparent 4px),radial-gradient(circle at 80% 85%, rgba(255,210,140,.9) 0 2px, transparent 3px);background-size:22px 22px}
                      .type-electric .particles::before{background-image:linear-gradient(135deg, transparent 45%, rgba(255,255,160,.85) 46%, rgba(255,255,160,.85) 54%, transparent 55%),linear-gradient(45deg, transparent 45%, rgba(255,255,160,.75) 46%, rgba(255,255,160,.75) 54%, transparent 55%);background-size:28px 28px;mix-blend-mode:screen}
                      .type-grass .particles::before{background-image:radial-gradient(circle at 25% 85%, rgba(170,255,180,.85) 0 2px, transparent 3px),radial-gradient(circle at 60% 90%, rgba(170,255,180,.8) 0 3px, transparent 4px),radial-gradient(circle at 80% 75%, rgba(170,255,180,.75) 0 2px, transparent 3px);background-size:26px 26px}
                      .type-normal .particles::before{background-image:radial-gradient(circle at 25% 85%, rgba(255,255,255,.5) 0 2px, transparent 3px),radial-gradient(circle at 60% 90%, rgba(255,255,255,.45) 0 3px, transparent 4px);background-size:26px 26px}
                  """)
                  css += addon
                  safe_write(mega_css, css)

          PY

      - name: Build (relative paths for GitHub Pages)
        working-directory: ${{ env.PROJECT_ROOT }}
        env:
          NODE_OPTIONS: --max_old_space_size=4096
        run: npm run build -- --configuration production --base-href "./" --deploy-url "./"

      - name: Locate index.html for Pages
        run: |
          set -e
          IDX="$(find "${{ env.PROJECT_ROOT }}/dist" -maxdepth 12 -type f -name index.html -print -quit)"
          if [ -z "$IDX" ]; then
            echo "ERROR: index.html not found in dist."
            exit 1
          fi
          PAGES_DIR="$(dirname "$IDX")"
          echo "PAGES_PATH=$PAGES_DIR" >> $GITHUB_ENV
          touch "$PAGES_DIR/.nojekyll"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ${{ env.PAGES_PATH }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
